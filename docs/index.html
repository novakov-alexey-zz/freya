<!DOCTYPE html><html><head><title>Freya: CRD Operator</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Alexey Novakov" /><meta name="description" content="Kubernetes Operator library for Scala" /><meta name="og:image" content="/freya/img/poster.png" /><meta name="image" property="og:image" content="/freya/img/poster.png" /><meta name="og:title" content="Freya: CRD Operator" /><meta name="title" property="og:title" content="Freya: CRD Operator" /><meta name="og:site_name" content="Freya" /><meta name="og:url" content="https://github.com/novakov-alexey/freya" /><meta name="og:type" content="website" /><meta name="og:description" content="Kubernetes Operator library for Scala" /><link rel="icon" type="image/png" href="/freya/img/favicon.png" /><meta name="twitter:title" content="Freya: CRD Operator" /><meta name="twitter:image" content="https://novakov-alexey.github.io/freya//freya/img/poster.png" /><meta name="twitter:description" content="Kubernetes Operator library for Scala" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="@freya-scala" /><meta name="twitter:creator" content="@alexey_novakov" /><link rel="icon" type="image/png" sizes="16x16" href="/freya/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/freya/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/freya/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/freya/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/freya/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/freya/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/freya/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/freya/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/freya/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/freya/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/freya/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/freya/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/freya/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/freya/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/freya/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/freya/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/freya/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/freya/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/freya/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/freya/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/freya/highlight/styles/atelier-sulphurpool-light.css" /><link rel="stylesheet" href="/freya/css/pattern-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/freya/" class="brand"><div class="brand-wrapper"><span>Freya</span></div></a></li> <li><a href="/freya/docs/" class=" active ">CRD Operator</a></li> <li><a href="/freya/docs/configmap-operator" class="">ConfigMap Operator</a></li> <li><a href="/freya/docs/resource-parsing" class="">Resource parsing</a></li> <li><a href="/freya/docs/configuration" class="">Configuration</a></li> <li><a href="/freya/docs/reconcile-events" class="">Reconcile Events</a></li> <li><a href="/freya/docs/structural-schema" class="">Structural Schema</a></li> <li><a href="/freya/docs/dependencies" class="">Dependencies</a></li> <li><a href="/freya/docs/future" class="">Future Work</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/novakov-alexey/freya" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/novakov-alexey/freya" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Freya Kubernetes Operator library for Scala');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Freya Kubernetes Operator library for Scala');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="novakov-alexey" data-github-repo="freya"><div class="content-wrapper"><section><h1 id="table-of-contents">Table of Contents</h1>
<ol>
  <li><a href="#implementation-steps-with-freya">Implementation Steps with Freya</a></li>
  <li><a href="#event-dispatching">Event Dispatching</a></li>
  <li><a href="#restart-configuration">Restart Configuration</a></li>
  <li><a href="#deploy-crd-manually">Deploy CRD Manually</a></li>
  <li><a href="#crd-helper">CRD Helper</a></li>
</ol>

<h1 id="crd-operator">CRD Operator</h1>

<p>Further in the documentation, <em>Controller</em> and <em>Operator</em> definitions are used as synonymous.</p>

<p>Letâ€™s take an example of some controller like <a href="http://web.mit.edu/KERBEROS/krb5-1.5/krb5-1.5.4/doc/krb5-user/What-is-a-Kerberos-Principal_003f.html">Kerberos principal</a>
list, which needs to be propagated to KDC database.</p>

<p>Using Custom Resource option, our target Custom Resource will look like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">io.myorg.kerboperator/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kerb</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">my-krb1</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">realm</span><span class="pi">:</span> <span class="s">EXAMPLE.COM</span>
  <span class="na">principals</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">client1</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">static</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">mypass</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">user2</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">static</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">mypass2</span>
</code></pre></div></div>

<p>Freya does not require to write YAML files for your custom resources definitions, nor for customer resource
instances and ConfigMaps at all. CRD in K8s will be created automatically based on case classes you define.</p>

<p>For the sake of example, we are not going to create any container with Kerberos server running in it, but just showing 
how Freya can help to watch our custom resources or ConfigMaps. Particular controller actions to be implemented by 
controller author using <strong>fabric8</strong> kubernetes-client. Freya is only a facilitator between K8s api-server and 
your custom controller actions.</p>

<h2 id="implementation-steps-with-freya">Implementation Steps with Freya</h2>

<p>There are 3 steps to implement a CRD Operator:</p>

<h3 id="1--define-resource-specification-as-a-hierarchy-of-case-classes">1 . Define resource specification as a hierarchy of case classes</h3>

<p>Above Kerberos spec can be designed as two case classes <code class="highlighter-rouge">Kerb</code> and <code class="highlighter-rouge">Principal</code></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Principal</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span><span class="o">)</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Kerb</span><span class="o">(</span><span class="n">realm</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">principals</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Principal</span><span class="o">])</span>
</code></pre></div></div>

<p>According to Kubernetes API, every custom resource may have optional property <code class="highlighter-rouge">status</code>. In order to model
status, we will define one more case class. Name and properties of this class can be anything. Basically, 
it can define its own hierarchy of case classes.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Status</span><span class="o">(</span><span class="n">ready</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="2--implement-your-actions-for-add-modify-delete-events">2 . Implement your actions for Add, Modify, Delete events</h3>

<p>Just extend <code class="highlighter-rouge">freya.Controller</code> abstract class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.typesafe.scalalogging.LazyLogging</span>
<span class="k">import</span> <span class="nn">cats.effect.ConcurrentEffect</span>
<span class="k">import</span> <span class="nn">cats.syntax.apply._</span>
<span class="k">import</span> <span class="nn">freya.Controller</span>
<span class="k">import</span> <span class="nn">freya.models.</span><span class="o">{</span><span class="nc">CustomResource</span><span class="o">,</span> <span class="nc">NewStatus</span><span class="o">}</span>

<span class="k">class</span> <span class="nc">KerbController</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">ConcurrentEffect</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> 
  <span class="k">extends</span> <span class="nc">Controller</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Kerb</span>, <span class="kt">Status</span><span class="o">]</span> <span class="k">with</span> <span class="nc">LazyLogging</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">onAdd</span><span class="o">(</span><span class="n">krb</span><span class="k">:</span> <span class="kt">CustomResource</span><span class="o">[</span><span class="kt">Kerb</span>, <span class="kt">Status</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">NewStatus</span><span class="o">[</span><span class="kt">Status</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nv">F</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nv">logger</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"new Krb added: ${krb.spec}, ${krb.metadata}"</span><span class="o">))</span> <span class="o">*&gt;</span> <span class="nv">F</span><span class="o">.</span><span class="py">pure</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="nc">Status</span><span class="o">(</span><span class="kc">true</span><span class="o">)))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">onDelete</span><span class="o">(</span><span class="n">krb</span><span class="k">:</span> <span class="kt">CustomResource</span><span class="o">[</span><span class="kt">Kerb</span>, <span class="kt">Status</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">F</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nv">logger</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Krb deleted: ${krb.spec}, ${krb.metadata}"</span><span class="o">))</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">onModify</span><span class="o">(</span><span class="n">krb</span><span class="k">:</span> <span class="kt">CustomResource</span><span class="o">[</span><span class="kt">Kerb</span>, <span class="kt">Status</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">NewStatus</span><span class="o">[</span><span class="kt">Status</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nv">F</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nv">logger</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Krb modified: ${krb.spec}, ${krb.metadata}"</span><span class="o">))</span> <span class="o">*&gt;</span> <span class="nv">F</span><span class="o">.</span><span class="py">pure</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="nc">Status</span><span class="o">(</span><span class="kc">true</span><span class="o">)))</span>
  
  <span class="k">override</span> <span class="k">def</span> <span class="nf">onInit</span><span class="o">()</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">F</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nv">logger</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"init completed"</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<p>where <code class="highlighter-rouge">type NewStatus[U] = Option[U]</code></p>

<p>All methods have default implementation as <code class="highlighter-rouge">F.pure(None)</code> or <code class="highlighter-rouge">F.unit</code>, so override only necessary methods for your custom controller.</p>

<p><code class="highlighter-rouge">onInit</code> - is called before controller is started. In terms <strong>fabric8</strong> client, <strong>onInit</strong> is called before watcher 
is started to watch for custom resources or ConfigMap resources.</p>

<p><code class="highlighter-rouge">onAdd</code>, <code class="highlighter-rouge">onDelete</code>, <code class="highlighter-rouge">onModify</code> - are called whenever corresponding event is triggered by Kubernetes api-server.</p>

<p><code class="highlighter-rouge">onAdd</code> and <code class="highlighter-rouge">onModify</code> - allows to set new custom resource status by returning a value of <code class="highlighter-rouge">F[Option[U]]</code> in these methods.
<code class="highlighter-rouge">U</code> is a type of status case class.</p>

<h3 id="3--start-your-operator">3 . Start your operator</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">ContextShift</span><span class="o">,</span> <span class="nc">ExitCode</span><span class="o">,</span> <span class="nc">IO</span><span class="o">,</span> <span class="nc">IOApp</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">io.fabric8.kubernetes.client.DefaultKubernetesClient</span>
<span class="k">import</span> <span class="nn">freya.K8sNamespace.Namespace</span>
<span class="k">import</span> <span class="nn">freya.Operator</span>
<span class="k">import</span> <span class="nn">freya.Configuration.CrdConfig</span>
<span class="k">import</span> <span class="nn">freya.json.jackson._</span>

<span class="k">object</span> <span class="nc">KerbCrdOperator</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">cs</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="n">contextShift</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">client</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultKubernetesClient</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">cfg</span> <span class="k">=</span> <span class="nc">CrdConfig</span><span class="o">(</span><span class="nc">Namespace</span><span class="o">(</span><span class="s">"test"</span><span class="o">),</span> <span class="n">prefix</span> <span class="k">=</span> <span class="s">"io.myorg.kerboperator"</span><span class="o">)</span>

    <span class="nc">Operator</span>
      <span class="o">.</span><span class="py">ofCrd</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Kerb</span>, <span class="kt">Status</span><span class="o">](</span><span class="n">cfg</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="k">new</span> <span class="nc">KerbController</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span>
      <span class="o">.</span><span class="py">run</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Operatorâ€™s <code class="highlighter-rouge">run</code> method returns an <code class="highlighter-rouge">IO[ExitCode]</code>, which is running a web-socket connection to Kubernetes api-server.
Returned <code class="highlighter-rouge">IO</code> value is a long-running and server-like task, which terminates only if K8s api-server closes client 
connection. Running Operator is watching for events:</p>
<ul>
  <li>for customer resources with <code class="highlighter-rouge">Kerb</code> kind and apiGroup <code class="highlighter-rouge">io.myorg.kerboperator/v1</code>, in case of CRD Operator</li>
  <li>for ConfigMap kind with label <code class="highlighter-rouge">io.myorg.kerboperator/kind=Kerb</code>, in case of ConfigMap Operator</li>
</ul>

<h2 id="event-dispatching">Event Dispatching</h2>

<p><img src="https://novakov-alexey.github.io/freya/img/freya_runtime.png" alt="freya_runtime" width="700" /></p>

<p>Freya dispatches api-server events concurrently accross different namespaces, but in original order within the same namespace. Supplied controller will be called concurrently, thus any state variables of the controller needs to be thread-safe or atomic. In order to use single-threaded dispatch, one can set <code class="highlighter-rouge">false</code> to <code class="highlighter-rouge">Configuration#concurrentController</code>.</p>

<p>Concurrent dispatching is maintaining in-memory queues per namespace to buffer received events for a short time. These events are dispatched one by one to the controller.</p>

<h2 id="restart-configuration">Restart configuration</h2>

<p>Freya can automatically restart your operator in case of any failure during the CRs/ConfigMaps event listening.
In terms Cats-Effect IO, once IO task is completed, which means Freya Operator has exited from its normal
listening process, it will be restarted with the same parameters. There are few options to control restart behaviour.</p>

<h3 id="retry-infinitely-with-random-delay">Retry infinitely with random delay</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">IO</span><span class="o">,</span> <span class="nc">Timer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">freya.Retry.Infinite</span>
<span class="k">import</span> <span class="nn">freya.Operator</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">timer</span><span class="k">:</span> <span class="kt">Timer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">timer</span><span class="o">(</span><span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">global</span><span class="o">)</span>  
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">cs</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">global</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">cfg</span> <span class="k">=</span> <span class="nc">CrdConfig</span><span class="o">(</span><span class="nc">Namespace</span><span class="o">(</span><span class="s">"test"</span><span class="o">),</span> <span class="n">prefix</span> <span class="k">=</span> <span class="s">"io.myorg.kerboperator"</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">client</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultKubernetesClient</span><span class="o">)</span>

<span class="nc">Operator</span>
  <span class="o">.</span><span class="py">ofCrd</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Kerb</span>, <span class="kt">Status</span><span class="o">](</span><span class="n">cfg</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="k">new</span> <span class="nc">KerbController</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span>
   <span class="o">.</span><span class="py">withRestart</span><span class="o">(</span><span class="nc">Infinite</span><span class="o">(</span><span class="n">minDelay</span> <span class="k">=</span> <span class="mf">1.</span><span class="n">second</span><span class="o">,</span> <span class="n">maxDelay</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">))</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Infinite</code> type will restart operator infinitely making random delay between retries within <code class="highlighter-rouge">[minDelay, maxDelay)</code> time range.</p>

<h3 id="retry-with-fixed-number-of-restarts">Retry with fixed number of restarts</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">IO</span><span class="o">,</span> <span class="nc">Timer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">freya.Retry.Times</span>
<span class="k">import</span> <span class="nn">freya.Operator</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">timer</span><span class="k">:</span> <span class="kt">Timer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">timer</span><span class="o">(</span><span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">global</span><span class="o">)</span>  
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">cs</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">global</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">cfg</span> <span class="k">=</span> <span class="nc">CrdConfig</span><span class="o">(</span><span class="nc">Namespace</span><span class="o">(</span><span class="s">"test"</span><span class="o">),</span> <span class="n">prefix</span> <span class="k">=</span> <span class="s">"io.myorg.kerboperator"</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">client</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultKubernetesClient</span><span class="o">)</span>

<span class="nc">Operator</span>
  <span class="o">.</span><span class="py">ofCrd</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Kerb</span>, <span class="kt">Status</span><span class="o">](</span><span class="n">cfg</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="k">new</span> <span class="nc">KerbController</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span>
   <span class="o">.</span><span class="py">withRestart</span><span class="o">(</span><span class="nc">Times</span><span class="o">(</span><span class="n">maxRetries</span> <span class="k">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">delay</span> <span class="k">=</span> <span class="mf">2.</span><span class="n">seconds</span><span class="o">,</span> <span class="n">multiplier</span> <span class="k">=</span> <span class="mi">2</span><span class="o">))</span>
</code></pre></div></div>

<p>Above configuration will lead to the following delay in seconds: 2, 4 and 8. <code class="highlighter-rouge">multiplier</code> is used to 
calculate next delay by <code class="highlighter-rouge">previous delay * multiplier</code>.</p>

<h2 id="deploy-crd-manually">Deploy CRD manually</h2>

<p>In order to disable automatic deployment of Custom Resource Definition as well as OpenAPi schema, one can
set false in <code class="highlighter-rouge">freya.Configuration.CrdConfig.deployCrd = false</code>. Operator will expect to find a CRD in K8s during the startup, it 
wonâ€™t try to deploy new CRD, even if CRD is not found. However, what may happen in case CRD is not found and <code class="highlighter-rouge">deployCrd</code>
is <code class="highlighter-rouge">false</code>, then operator will fail and return failed <code class="highlighter-rouge">IO</code> value immediately. Freya Operator canâ€™t work without CRD being
retrieved from K8s api-server.</p>

<p>Manual deployment of CRD is usually done with YAML files using tools like <code class="highlighter-rouge">kubectl</code>.</p>

<h2 id="controller-helpers">Controller Helpers</h2>

<p>Both types of controllers can be constructed using helper as input parameter. Helper has several useful properties and
method to retrieve current resources for CRD or ConfigMap kinds. Although, the same functionality can be written
within Operator code manually.</p>

<h3 id="crd-helper">CRD Helper</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">IO</span><span class="o">,</span> <span class="nc">Timer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">freya.CrdHelper</span>
<span class="k">import</span> <span class="nn">freya.models.NoStatus</span>  
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">timer</span><span class="k">:</span> <span class="kt">Timer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">timer</span><span class="o">(</span><span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">global</span><span class="o">)</span>  
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">cs</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">global</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">cfg</span> <span class="k">=</span> <span class="nc">CrdConfig</span><span class="o">(</span><span class="nc">Namespace</span><span class="o">(</span><span class="s">"test"</span><span class="o">),</span> <span class="n">prefix</span> <span class="k">=</span> <span class="s">"io.myorg.kerboperator"</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">client</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultKubernetesClient</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">controller</span> <span class="k">=</span> <span class="o">(</span><span class="n">helper</span><span class="k">:</span> <span class="kt">CrdHelper</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Kerb</span>, <span class="kt">NoStatus</span><span class="o">])</span> <span class="k">=&gt;</span>
  <span class="k">new</span> <span class="nc">Controller</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Kerb</span>, <span class="kt">NoStatus</span><span class="o">]</span> <span class="o">{</span>

    <span class="k">override</span> <span class="k">def</span> <span class="nf">onInit</span><span class="o">()</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
      <span class="nv">helper</span><span class="o">.</span><span class="py">currentResources</span><span class="o">.</span><span class="py">fold</span><span class="o">(</span>
        <span class="nv">IO</span><span class="o">.</span><span class="py">raiseError</span><span class="o">,</span> <span class="c1">// refusing to process</span>
        <span class="n">r</span> <span class="k">=&gt;</span>
            <span class="nc">IO</span><span class="o">(</span><span class="nv">r</span><span class="o">.</span><span class="py">foreach</span> <span class="o">{</span>
                <span class="k">case</span> <span class="nc">Left</span><span class="o">((</span><span class="n">error</span><span class="o">,</span> <span class="n">r</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Failed to parse CR instances $r, error = $error"</span><span class="o">)</span>
                <span class="k">case</span> <span class="nc">Right</span><span class="o">(</span><span class="n">resource</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"current ${cfg.getKind} CRs: ${resource.spec}"</span><span class="o">)</span>
            <span class="o">})</span>
      <span class="o">)</span>
  <span class="o">}</span>

<span class="nc">Operator</span>
  <span class="o">.</span><span class="py">ofCrd</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Kerb</span>, <span class="kt">NoStatus</span><span class="o">](</span><span class="n">cfg</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="n">controller</span><span class="o">)</span>
  <span class="o">.</span><span class="py">withRestart</span><span class="o">()</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">CrdHelper</code> provides several properties such as:</p>

<ul>
  <li><code class="highlighter-rouge">freya.Configuration.CrdConfig</code> - configuration which is passed on operator construction</li>
  <li><code class="highlighter-rouge">io.fabric8.kubernetes.client.KubernetesClient</code> - K8s client</li>
  <li><code class="highlighter-rouge">Option[Boolean]</code> - isOpenShift property</li>
  <li><code class="highlighter-rouge">io.fabric8.kubernetes.api.model.apiextensions.CustomResourceDefinition</code> - custom resource definition object</li>
  <li><code class="highlighter-rouge">freya.resource.CrdParser</code> - CR parser to parse <code class="highlighter-rouge">freya.watcher.AnyCustomResource#spec</code> to target <code class="highlighter-rouge">T</code> kind.</li>
</ul>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/freya/highlight/highlight.pack.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yaml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/json.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/yml.min.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash','yaml','json','yml']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'freya-scala/community'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/freya/js/main.js"></script></body></html>