(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{123:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/freya_runtime-5f2f63bd98f89464d29aba48ef328036.png"},74:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return i})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return s}));var r=n(3),a=(n(0),n(82));const o={title:"CRD Operator"},i={unversionedId:"crd-operator",id:"crd-operator",isDocsHomePage:!1,title:"CRD Operator",description:"\x3c!-- # Table of Contents",source:"@site/../docs/target/mdoc/crd-operator.md",slug:"/crd-operator",permalink:"/freya/crd-operator",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/../docs/target/mdoc/crd-operator.md",version:"current",sidebar:"docs",previous:{title:"Overview",permalink:"/freya/"},next:{title:"ConfigMap Operator",permalink:"/freya/configmap-operator"}},l=[{value:"Implementation Steps with Freya",id:"implementation-steps-with-freya",children:[{value:"1 . Define resource specification as a hierarchy of case classes",id:"1--define-resource-specification-as-a-hierarchy-of-case-classes",children:[]},{value:"2 . Implement your actions for Add, Modify, Delete events",id:"2--implement-your-actions-for-add-modify-delete-events",children:[]},{value:"3 . Start your operator",id:"3--start-your-operator",children:[]}]},{value:"Event Dispatching",id:"event-dispatching",children:[]},{value:"Restart configuration",id:"restart-configuration",children:[{value:"Retry infinitely with random delay",id:"retry-infinitely-with-random-delay",children:[]},{value:"Retry with fixed number of restarts",id:"retry-with-fixed-number-of-restarts",children:[]}]},{value:"Deploy CRD manually",id:"deploy-crd-manually",children:[]},{value:"Controller Helpers",id:"controller-helpers",children:[{value:"CRD Helper",id:"crd-helper",children:[]}]}],c={toc:l};function s({components:e,...t}){return Object(a.b)("wrapper",Object(r.a)({},c,t,{components:e,mdxType:"MDXLayout"}),Object(a.b)("p",null,"Further in the documentation, ",Object(a.b)("em",{parentName:"p"},"Controller")," and ",Object(a.b)("em",{parentName:"p"},"Operator")," definitions are used as synonymous."),Object(a.b)("p",null,"Let's take an example of some controller like ",Object(a.b)("a",{parentName:"p",href:"http://web.mit.edu/KERBEROS/krb5-1.5/krb5-1.5.4/doc/krb5-user/What-is-a-Kerberos-Principal_003f.html"},"Kerberos principal"),"\nlist, which needs to be propagated to KDC database. "),Object(a.b)("p",null,"Using Custom Resource option, our target Custom Resource will look like this:  "),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: io.myorg.kerboperator/v1\nkind: Kerb\nmetadata:\n  name: my-krb1\n  namespace: test\nspec:\n  realm: EXAMPLE.COM\n  principals:\n    - name: client1\n      password: static\n      value: mypass\n    - name: user2\n      password: static\n      value: mypass2\n")),Object(a.b)("p",null,"Freya does not require to write YAML files for your custom resources definitions, nor for customer resource\ninstances and ConfigMaps at all. CRD in K8s will be created automatically based on case classes you define."),Object(a.b)("p",null,"For the sake of example, we are not going to create any container with Kerberos server running in it, but just showing\nhow Freya can help to watch our custom resources or ConfigMaps. Particular controller actions to be implemented by\ncontroller author using ",Object(a.b)("strong",{parentName:"p"},"fabric8")," kubernetes-client. Freya is only a facilitator between K8s api-server and\nyour custom controller actions."),Object(a.b)("h2",{id:"implementation-steps-with-freya"},"Implementation Steps with Freya"),Object(a.b)("p",null,"There are 3 steps to implement a CRD Operator:"),Object(a.b)("h3",{id:"1--define-resource-specification-as-a-hierarchy-of-case-classes"},"1 . Define resource specification as a hierarchy of case classes"),Object(a.b)("p",null,"Above Kerberos spec can be designed as two case classes ",Object(a.b)("inlineCode",{parentName:"p"},"Kerb")," and ",Object(a.b)("inlineCode",{parentName:"p"},"Principal")),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-scala"},'final case class Principal(name: String, password: String, value: String = "")\nfinal case class Kerb(realm: String, principals: List[Principal])\n')),Object(a.b)("p",null,"According to Kubernetes API, every custom resource may have optional property ",Object(a.b)("inlineCode",{parentName:"p"},"status"),". In order to model\nstatus, we will define one more case class. Name and properties of this class can be anything. Basically,\nit can define its own hierarchy of case classes."),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-scala"},"final case class Status(ready: Boolean)\n")),Object(a.b)("h3",{id:"2--implement-your-actions-for-add-modify-delete-events"},"2 . Implement your actions for Add, Modify, Delete events"),Object(a.b)("p",null,"Just extend ",Object(a.b)("inlineCode",{parentName:"p"},"freya.Controller")," abstract class:"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-scala"},'import com.typesafe.scalalogging.LazyLogging\nimport cats.effect.ConcurrentEffect\nimport cats.syntax.apply._\nimport freya.Controller\nimport freya.models.{CustomResource, NewStatus}\n\nclass KerbController[F[_]](implicit F: ConcurrentEffect[F]) \n  extends Controller[F, Kerb, Status] with LazyLogging {\n\n  override def onAdd(krb: CustomResource[Kerb, Status]): F[NewStatus[Status]] =\n    F.delay(\n      logger.info(s"new Krb added: ${krb.spec}, ${krb.metadata}")\n    ) *> F.pure(Some(Status(true)))\n\n  override def onDelete(krb: CustomResource[Kerb, Status]): F[Unit] =\n    F.delay(logger.info(s"Krb deleted: ${krb.spec}, ${krb.metadata}"))\n\n  override def onModify(krb: CustomResource[Kerb, Status]): F[NewStatus[Status]] =\n    F.delay(\n        logger.info(s"Krb modified: ${krb.spec}, ${krb.metadata}")\n    ) *> F.pure(Some(Status(true)))\n  \n  override def onInit(): F[Unit] =\n    F.delay(logger.info(s"init completed"))\n}\n')),Object(a.b)("p",null,"where ",Object(a.b)("inlineCode",{parentName:"p"},"type NewStatus[U] = Option[U]")),Object(a.b)("p",null,"All methods have default implementation as ",Object(a.b)("inlineCode",{parentName:"p"},"F.pure(None)")," or ",Object(a.b)("inlineCode",{parentName:"p"},"F.unit"),", so override only necessary methods for your custom controller."),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"onInit")," - is called before controller is started. In terms ",Object(a.b)("strong",{parentName:"p"},"fabric8")," client, ",Object(a.b)("strong",{parentName:"p"},"onInit")," is called before watcher\nis started to watch for custom resources or ConfigMap resources."),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"onAdd"),", ",Object(a.b)("inlineCode",{parentName:"p"},"onDelete"),", ",Object(a.b)("inlineCode",{parentName:"p"},"onModify")," - are called whenever corresponding event is triggered by Kubernetes api-server."),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"onAdd")," and ",Object(a.b)("inlineCode",{parentName:"p"},"onModify")," - allows to set new custom resource status by returning a value of ",Object(a.b)("inlineCode",{parentName:"p"},"F[Option[U]]")," in these methods.\n",Object(a.b)("inlineCode",{parentName:"p"},"U")," is a type of status case class."),Object(a.b)("h3",{id:"3--start-your-operator"},"3 . Start your operator"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-scala"},'import cats.effect.{ContextShift, ExitCode, IO, IOApp}\nimport io.fabric8.kubernetes.client.DefaultKubernetesClient\nimport freya.K8sNamespace.Namespace\nimport freya.Operator\nimport freya.Configuration.CrdConfig\nimport freya.json.jackson._\n\nobject KerbCrdOperator extends IOApp {\n  implicit val cs: ContextShift[IO] = contextShift\n\n  override def run(args: List[String]): IO[ExitCode] = {\n    val client = IO(new DefaultKubernetesClient)\n    val cfg = CrdConfig(Namespace("test"), prefix = "io.myorg.kerboperator")\n\n    Operator\n      .ofCrd[IO, Kerb, Status](cfg, client, new KerbController[IO])\n      .run\n  }\n}\n')),Object(a.b)("p",null,"Operator's ",Object(a.b)("inlineCode",{parentName:"p"},"run")," method returns an ",Object(a.b)("inlineCode",{parentName:"p"},"IO[ExitCode]"),", which is running a web-socket connection to Kubernetes api-server.\nReturned ",Object(a.b)("inlineCode",{parentName:"p"},"IO")," value is a long-running and server-like task, which terminates only if K8s api-server closes client\nconnection. Running Operator is watching for events:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"for customer resources with ",Object(a.b)("inlineCode",{parentName:"li"},"Kerb")," kind and apiGroup ",Object(a.b)("inlineCode",{parentName:"li"},"io.myorg.kerboperator/v1"),", in case of CRD Operator"),Object(a.b)("li",{parentName:"ul"},"for ConfigMap kind with label ",Object(a.b)("inlineCode",{parentName:"li"},"io.myorg.kerboperator/kind=Kerb"),", in case of ConfigMap Operator")),Object(a.b)("h2",{id:"event-dispatching"},"Event Dispatching"),Object(a.b)("p",null,Object(a.b)("img",{alt:"Freya Runtime",src:n(123).default})),Object(a.b)("p",null,"Freya dispatches api-server events concurrently accross different namespaces, but in original order within the same namespace. Supplied controller will be called concurrently, thus any state variables of the controller needs to be thread-safe or atomic. In order to use single-threaded dispatch, one can set ",Object(a.b)("inlineCode",{parentName:"p"},"false")," to ",Object(a.b)("inlineCode",{parentName:"p"},"Configuration#concurrentController"),". "),Object(a.b)("p",null,"Concurrent dispatching is maintaining in-memory queues per namespace to buffer received events for a short time. These events are dispatched one by one to the controller. "),Object(a.b)("h2",{id:"restart-configuration"},"Restart configuration"),Object(a.b)("p",null,"Freya can automatically restart your operator in case of any failure during the CRs/ConfigMaps event listening.\nIn terms Cats-Effect IO, once IO task is completed, which means Freya Operator has exited from its normal\nlistening process, it will be restarted with the same parameters. There are few options to control restart behaviour."),Object(a.b)("h3",{id:"retry-infinitely-with-random-delay"},"Retry infinitely with random delay"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-scala"},'import cats.effect.{IO, Timer}\nimport freya.Retry.Infinite\nimport freya.Operator\nimport scala.concurrent.duration._\nimport scala.concurrent.ExecutionContext\n\nimplicit val timer: Timer[IO] = IO.timer(ExecutionContext.global)  \nimplicit val cs: ContextShift[IO] = IO.contextShift(ExecutionContext.global)\nval cfg = CrdConfig(Namespace("test"), prefix = "io.myorg.kerboperator")\nval client = IO(new DefaultKubernetesClient)\n\nOperator\n  .ofCrd[IO, Kerb, Status](cfg, client, new KerbController[IO])\n   .withRestart(Infinite(minDelay = 1.second, maxDelay = 10.seconds))\n')),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"Infinite")," type will restart operator infinitely making random delay between retries within ",Object(a.b)("inlineCode",{parentName:"p"},"[minDelay, maxDelay)")," time range."),Object(a.b)("h3",{id:"retry-with-fixed-number-of-restarts"},"Retry with fixed number of restarts"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-scala"},'import cats.effect.{IO, Timer}\nimport freya.Retry.Times\nimport freya.Operator\nimport scala.concurrent.duration._\nimport scala.concurrent.ExecutionContext\n\nimplicit val timer: Timer[IO] = IO.timer(ExecutionContext.global)  \nimplicit val cs: ContextShift[IO] = IO.contextShift(ExecutionContext.global)\nval cfg = CrdConfig(Namespace("test"), prefix = "io.myorg.kerboperator")\nval client = IO(new DefaultKubernetesClient)\n\nOperator\n  .ofCrd[IO, Kerb, Status](cfg, client, new KerbController[IO])\n   .withRestart(Times(maxRetries = 3, delay = 2.seconds, multiplier = 2))\n')),Object(a.b)("p",null,"Above configuration will lead to the following delay in seconds: 2, 4 and 8. ",Object(a.b)("inlineCode",{parentName:"p"},"multiplier")," is used to\ncalculate next delay by ",Object(a.b)("inlineCode",{parentName:"p"},"previous delay * multiplier"),"."),Object(a.b)("h2",{id:"deploy-crd-manually"},"Deploy CRD manually"),Object(a.b)("p",null,"In order to disable automatic deployment of Custom Resource Definition as well as OpenAPi schema, one can\nset false in ",Object(a.b)("inlineCode",{parentName:"p"},"freya.Configuration.CrdConfig.deployCrd = false"),". Operator will expect to find a CRD in K8s during the startup, it\nwon't try to deploy new CRD, even if CRD is not found. However, what may happen in case CRD is not found and ",Object(a.b)("inlineCode",{parentName:"p"},"deployCrd"),"\nis ",Object(a.b)("inlineCode",{parentName:"p"},"false"),", then operator will fail and return failed ",Object(a.b)("inlineCode",{parentName:"p"},"IO")," value immediately. Freya Operator can't work without CRD being\nretrieved from K8s api-server. "),Object(a.b)("p",null,"Manual deployment of CRD is usually done with YAML files using tools like ",Object(a.b)("inlineCode",{parentName:"p"},"kubectl"),".   "),Object(a.b)("h2",{id:"controller-helpers"},"Controller Helpers"),Object(a.b)("p",null,"Both types of controllers can be constructed using helper as input parameter. Helper has several useful properties and\nmethod to retrieve current resources for CRD or ConfigMap kinds. Although, the same functionality can be written\nwithin Operator code manually."),Object(a.b)("h3",{id:"crd-helper"},"CRD Helper"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-scala"},'import cats.effect.{IO, Timer}\nimport freya.CrdHelper\nimport freya.models.NoStatus  \nimport scala.concurrent.ExecutionContext\n\nimplicit val timer: Timer[IO] = IO.timer(ExecutionContext.global)  \nimplicit val cs: ContextShift[IO] = IO.contextShift(ExecutionContext.global)\n\nval cfg = CrdConfig(Namespace("test"), prefix = "io.myorg.kerboperator")\nval client = IO(new DefaultKubernetesClient)\nval controller = (helper: CrdHelper[IO, Kerb, NoStatus]) =>\n  new Controller[IO, Kerb, NoStatus] {\n\n    override def onInit(): IO[Unit] =\n      helper.currentResources().fold(\n        IO.raiseError, // refusing to process\n        r =>\n            IO(r.foreach {\n                case Left((error, r)) => \n                  println(s"Failed to parse CR instances $r, error = $error")\n                case Right(resource) => \n                  println(s"current ${cfg.getKind} CRs: ${resource.spec}")\n            })\n      )\n  }\n\nOperator\n  .ofCrd[IO, Kerb, NoStatus](cfg, client, controller)\n  .withRestart()\n')),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"CrdHelper")," provides several properties such as: "),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"freya.Configuration.CrdConfig")," - configuration which is passed on operator construction"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"io.fabric8.kubernetes.client.KubernetesClient")," - K8s client"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"Option[Boolean]")," - isOpenShift property"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"io.fabric8.kubernetes.api.model.apiextensions.CustomResourceDefinition")," - custom resource definition object"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"freya.resource.CrdParser")," - CR parser to parse ",Object(a.b)("inlineCode",{parentName:"li"},"freya.watcher.AnyCustomResource#spec")," to target ",Object(a.b)("inlineCode",{parentName:"li"},"T")," kind.")))}s.isMDXComponent=!0},82:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=a.a.createContext({}),p=function(e){var t=a.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},b=function(e){var t=p(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),b=p(n),d=r,m=b["".concat(i,".").concat(d)]||b[d]||u[d]||o;return n?a.a.createElement(m,l(l({ref:t},s),{},{components:n})):a.a.createElement(m,l({ref:t},s))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var s=2;s<o;s++)i[s]=n[s];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);